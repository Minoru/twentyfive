<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TimeTracker</title>
	<style>
* {margin:0;padding:0;}
html {font-family: "Helvetica Neue", Helvetica, sans-serif;}

body {transition: background .5s ease-in;}
body.list {background: #3498db;}
body.countdown {background: #2c3e50;}
body.naming {background: #1abc9c;}

body.list .page.list,
body.countdown .page.countdown,
body.naming .page.naming {opacity:1;z-index:1000;transition: opacity .5s ease-in;}

h1 {display:none;}

.page {opacity:0;transition: opacity .1s ease-in;display: block;position: absolute;width: 100%;}

/* Countdown */
.countdown {height: 300px;width: 400px;position: absolute;top: 50%;left: 50%;margin: -350px auto auto -200px;}
	.countdown .progress {position: fixed;top: 0;left: 0;width: 100%;height: 3px;background: rgba(0,0,0,0.3);}
		.countdown .bar {position: fixed;top: 0;left: 0;width: 0%;height: 3px;background: rgba(231, 76, 60, 0.8);}
	.countdown .clock {font-size: 10rem;text-align: center;color: #fff;padding-top: 250px;text-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);}
	.countdown .estimate {text-align: center;font-size: 1rem;margin-top: -20px;opacity: .2;}

/* Naming */
.naming .title {display: block;width: 40rem;font-size: 2rem;margin: 10px auto;margin-top: 250px;padding: 20px;text-align:center;}

/* List */
.list .start {margin: 40px auto;}
	.list .tasklist {overflow-y: scroll;height: 400px;}
.list li {background: #fff;width: 340px;margin: 20px auto;box-shadow: 0 5px 5px rgba(44, 62, 80, 0.1);padding: 20px 30px 30px;list-style:none;position:relative;text-align: center;opacity:.8;transition: opacity .3s ease-in;}
	.list li:hover {opacity:1;}
	.list li:before {content: "";border: 8px solid transparent;border-top: 8px solid #fff;position: absolute;bottom: -16px;left: 50%;margin-left: -8px;}
	.list .title {font-size: 1.66rem;}
	.list .detail {opacity: .66;font-size: 1.5rem;line-height: 1rem;font-weight: 100;}
	.list .interval {opacity: .33;display:block;font-size: .6rem;font-weight: 500;margin-bottom: 0.5rem;text-transform: uppercase;}
	.list .delete {display:none;cursor:pointer;top: -3px;position: absolute;right: 0;line-height: 1rem;color: #999;}
	.list li:hover .delete {display:block;}

footer {position: fixed;bottom: 20px;left: 20px;}
	footer a {text-decoration: none;opacity: .5;color: #fff;


/* Buttons */
button {cursor: pointer;opacity:.9;transition: opacity .3s ease-in;}
	button:hover {cursor: pointer;opacity:1;}
.primary,
.secondary {display: block;margin: 10px auto;padding: 0.5em 2rem;font-size: 1rem;background: transparent;border: 2px solid #1abc9c;color: #1abc9c;}
.primary {background: #e74c3c;color: #fff;border: none;font-size: 1.33rem;padding: 1rem 4rem;}
.secondary {opacity:.8;}
.danger {position: fixed;bottom: 20px;right: 20px;background: none;border: none;font-size: 0.5rem;text-transform: uppercase;color: #fff;opacity:.4;}
	.danger:hover {color: #FF4849;opacity:1;}




/* Debug
.page {opacity:1 !important;background: transparent !important;}
 */
	</style>


	<link rel="shortcut icon" href="favicon.png">
</head>
<body class="">

	<h1>TimeTracker</h1>

	<div id="countdown" class="page countdown">
		<div class="progress">
			<div id="bar" class="bar"></div>
		</div>
		<p id="clock" class="clock">25:00</p>
		<p id="estimate" class="estimate">0:00 - 25:00</p>
		<button id="finishCountdown" class="secondary" title="Finish the current task">I'm done</button>
		<button id="cancelCountdown" class="danger" title="Cancel the current task">Cancel</button>
	</div>

	<div id="naming" class="page naming">
		<input type="text" id="taskTitle" class="title" placeholder="What have you been working on?" title="Be as descriptive as possible&hellip;">
		<button id="saveNaming" class="primary" title="Save task">Save task</button>
		<button id="cancelNaming" class="danger" title="Cancel the current task">Cancel</button>
	</div>

	<div id="list" class="page list">
		<button id="startCountdown" class="primary start" title="Start a new task">Get back to work</button>
		<ul id="taskList" class="tasklist">
			<!-- <li>
				<p class="title">Task title</p>
				<p class="detail"><span class="interval">23 min</span>9:00&mdash;9:23</p>
			</li> -->
		</ul>
		<button id="clearTasks" class="danger" title="Remove all tasks">Reset</button>
	</div>

	<footer><a href="https://github.com/luckyshot/timetracker" title="View source code" target="_blank">â˜º</a></footer>

<script src="tinycon.min.js"></script>
<script>

;( function( doc, win ) {

'use strict';

var TimeTracker = {

		cycle: 25*60, // in seconds

		status: 'idle', // idle, running,
		page: 'countdown', // countdown, naming, list
		clock: 0,

		interval: 1000,

		audio: new Audio("alert.mp3"),

	selectView: function(page) {
		doc.body.className = page;
		if (page==='list') {
			var tT = doc.getElementById('taskTitle');
			setTimeout(function(){
				tT.focus();
				tT.select();
			}, 100);
		}
	},

	secsToTime: function(s) {
		return parseInt(s / 60) +':'+ ('0'+s % 60).slice(-2);
	},


	/**
	 * Countdown
	 */
	startCountdown: function() {
		doc.getElementById('clock').innerHTML = '25:00';
		TimeTracker.startTimer();
		TimeTracker.selectView('countdown');
	},

	// Timer finished or user clicked Done
	finishCountdown: function() {
		TimeTracker.resetCountdown();

		var duration = (TimeTracker.cycle-TimeTracker.clock)*1000;
		TimeTracker.currentTask = {
			start: Date.now()-duration,
			duration: duration,
			end: Date.now(),
			title: '', // will be saved in saveNaming
		};

		TimeTracker.selectView('naming');
	},

	cancelCountdown: function() {
		TimeTracker.resetCountdown();
		TimeTracker.selectView('list');
	},

	resetCountdown: function() {
		clearInterval(TimeTracker.t);
		TimeTracker.status = 'idle';
		Tinycon.reset();
	},

	/**
	 * Timer
	 */

	startTimer: function() {
		var self = this;
		if (TimeTracker.status != 'running') {
			Tinycon.setOptions({
				width: 11,
				height: 10,
				font: '12px helvetica',
				colour: '#ffffff',
				background: '#1abc9c'
			});
			doc.getElementById('estimate').innerHTML = TimeTracker.timestampToDate(Date.now()) + ' - ' + TimeTracker.timestampToDate(Date.now()+TimeTracker.cycle*1000);
			TimeTracker.clock = TimeTracker.cycle;
			TimeTracker.t = setInterval(function(){
				self.clock--;
				doc.getElementById('clock').innerHTML = self.secsToTime( self.clock );

				doc.getElementById('bar').style.width = (100-(self.clock / self.cycle * 100))+'%';

				Tinycon.setBubble( parseInt(self.clock/60) );

				if (self.clock < 1) {
					Tinycon.setBubble('END');
					Tinycon.setOptions({
						width: 7,
						height: 70,
						font: '7px helvetica',
						colour: '#ffffff',
						background: '#e74c3c'
					});
					win.blur();
					TimeTracker.audio.loop = true;
					TimeTracker.audio.play();
					self.finishCountdown();
				}

			}, TimeTracker.interval);
			TimeTracker.status = 'running';
		}
	},


	/**
	 * Naming
	 */

	saveNaming: function() {
		TimeTracker.currentTask.title = doc.getElementById('taskTitle').value;

		TimeTracker.windowFocused(); // TODO make sure stop audio loop bug

		Tinycon.reset();

		// Add task at the beginning
		TimeTracker.db.tasks.unshift(TimeTracker.currentTask);

		TimeTracker.saveDatabase();

		TimeTracker.refreshList();

		TimeTracker.selectView('list');
	},

	cancelNaming: function() {
		TimeTracker.selectView('list');
	},

	refreshList: function() {
		document.getElementById('taskList').innerHTML = '';
		for (var i = 0; i < TimeTracker.db.tasks.length; i++) {
			document.getElementById('taskList').innerHTML +=
				'<li>'+
					'<p class="title">'+TimeTracker.db.tasks[i].title+'</p>'+
					'<p class="detail">'+
						'<span class="interval">'+parseInt(TimeTracker.db.tasks[i].duration / 60 / 1000)+' minutes</span>'+
						TimeTracker.timestampToDate(TimeTracker.db.tasks[i].start)+' - '+
						TimeTracker.timestampToDate(TimeTracker.db.tasks[i].end)+
					'</p>'+
					'<i class="delete" title="Remove this task" data-id="'+i+'">&times;</i>'+
				'</li>';
		}
	},


	// Retrieves tasks and config saved in Database
	loadDatabase: function() {
		var lsDb = localStorage.getItem('TimeTracker');
		TimeTracker.db = (lsDb) ? JSON.parse(lsDb) : {'tasks':[]};
	},

	saveDatabase: function() {
		localStorage.setItem( 'TimeTracker', JSON.stringify(TimeTracker.db) );
	},

	clearTasks: function() {
		if (!confirm('Do you want to delete all tasks?')) return false;
		localStorage.removeItem('TimeTracker');
		TimeTracker.saveDatabase();
		TimeTracker.loadDatabase();
		TimeTracker.refreshList();
	},


	timestampToDate: function(timestamp) {
		var date = new Date(timestamp);
		return date.getHours()+':'+('0'+date.getMinutes()).slice(-2);
	},

	windowFocused: function() {
		TimeTracker.audio.loop = false;
		TimeTracker.audio.pause();
	},

	initEvents: function() {
		// Page List
		doc.getElementById('startCountdown').onclick = TimeTracker.startCountdown;
		doc.getElementById('clearTasks').onclick = TimeTracker.clearTasks;

		// Page Countdown
		doc.getElementById('finishCountdown').onclick = TimeTracker.finishCountdown;
		doc.getElementById('cancelCountdown').onclick = TimeTracker.cancelCountdown;

		// Page Naming
		doc.getElementById('saveNaming').onclick = TimeTracker.saveNaming;
		doc.getElementById('cancelNaming').onclick = TimeTracker.cancelNaming;

		win.onfocus = TimeTracker.windowFocused;
	},

	init: function() {
		TimeTracker.initEvents();
		TimeTracker.loadDatabase();
		TimeTracker.refreshList();
		if (TimeTracker.db.tasks.length>0) {
			TimeTracker.selectView('list');
		}else{
			TimeTracker.startCountdown();
		}
	}
};


TimeTracker.init();


}( document, window ) );

</script>


</body>
</html>
